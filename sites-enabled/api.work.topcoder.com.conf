    #||||||||||||||||||||||
    # Server for API V2 
    #||||||||||||||||||||||  
    server {
        listen       8000;
        #charset koi8-r;
        error_log   /var/log/nginx/logs/api_error.log  error;
        access_log  /var/log/nginx/logs/api_access.log  main;
        
        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
            }


        location /sample {
            proxy_pass http://sample-service.elasticbeanstalk.com/sample;
        }

        location /sample/person {
            proxy_pass http://sample-service.elasticbeanstalk.com/sample/person;
            include includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/work {
                resolver dns01.topcoder.com valid=30s;
                set $work "ap-work-prod.elasticbeanstalk.com";
                proxy_pass http://$work/v3/work; 
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/work-files {
                resolver dns01.topcoder.com valid=30s;
                set $work "ap-work-prod.elasticbeanstalk.com";
                proxy_pass http://$work/v3/work-files;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/attachments {
                resolver dns01.topcoder.com valid=30s;
                set $asp "ap-asp-prod.elasticbeanstalk.com";
                proxy_pass http://ap-asp-prod.elasticbeanstalk.com/v3/attachments;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/copilots {
                resolver dns01.topcoder.com valid=30s;
                set $copilot "ap-copilot-qa.elasticbeanstalk.com";
                proxy_pass http://$copilot/copilots;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/messages {
                resolver dns01.topcoder.com valid=30s;
                set $messaging "ap-messaging-prod.elasticbeanstalk.com";
                proxy_pass http://$messaging/v3/messages;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/threads {
                resolver dns01.topcoder.com valid=30s;
                set $messaging "ap-messaging-prod.elasticbeanstalk.com";
                proxy_pass http://$messaging/v3/threads;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/submissions {
                resolver dns01.topcoder.com valid=30s;
                set $submission "ap-submission-prod.elasticbeanstalk.com";
                proxy_pass http://$submission/v3/submissions;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/app-submissions {
                resolver dns01.topcoder.com valid=30s;
                set $asp "ap-asp-prod.elasticbeanstalk.com";
                proxy_pass http://$asp/v3/app-submissions;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/inboxes {
                resolver dns01.topcoder.com valid=30s;
                set $asp "ap-asp-prod.elasticbeanstalk.com";
                proxy_pass http://$asp/v3/inboxes;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/profiles {
                resolver dns01.topcoder.com valid=30s;
                set $asp "ap-asp-prod.elasticbeanstalk.com";
                proxy_pass http://$asp/v3/profiles;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/projects {
                resolver dns01.topcoder.com valid=30s;
                set $asp "ap-asp-prod.elasticbeanstalk.com";
                proxy_pass http://$asp/v3/projects;
                include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/authorizations {
            resolver dns01.topcoder.com valid=30s;
            set $ebsHost "ap-identity-prod.elasticbeanstalk.com";
            proxy_pass http://$ebsHost/v3/authorizations;
            include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/users {
            resolver dns01.topcoder.com valid=30s;
            set $ebsHost "ap-identity-prod.elasticbeanstalk.com";
            proxy_pass http://$ebsHost;
            include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/users/login {
            proxy_pass http://ap-identity-prod.elasticbeanstalk.com;
            include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
            # Restrict access to this endpoint to Auth0 IPs only.
            # This is kind of hacky as we have to include the Sophos IP as well as it shows up in the
            # X-Forwarded-For header. Need to recompile nginx to use the $real_ip information.
            set $allow false; 
            if ($http_x_forwarded_for = "138.91.154.99, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.221.228.15, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.183.64.135, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.67.77.38, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.67.15.170, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.183.204.205, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.173.21.107, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "54.85.173.28, 10.20.45.5") 
                { set $allow true; } 
            if ($http_x_forwarded_for = "68.9.92.14, 10.20.45.5") 
                { set $allow true; } 
            if ($allow = false) 
                { return 403; } 
        }

        location /v3/files {
            resolver dns01.topcoder.com valid=30s;
            set $ebsHost "ap-file-prod.elasticbeanstalk.com";
            proxy_pass http://$ebsHost/v3/files;
            include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/roles {
            resolver dns01.topcoder.com valid=30s;
            set $ebsHost "ap-identity-prod.elasticbeanstalk.com";
            proxy_pass http://$ebsHost/v3/roles;
            include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

        location /v3/permissions {
            resolver dns01.topcoder.com valid=30s;
            set $ebsHost "ap-identity-prod.elasticbeanstalk.com";
            proxy_pass http://$ebsHost/v3/permissions;
            include /etc/nginx/includes/api.topcoder.com.v3location.nginx.conf;
        }

}
