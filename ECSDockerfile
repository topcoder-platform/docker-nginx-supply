FROM ubuntu:xenial

LABEL app="nginx-supply" version="1.0"

RUN apt update
RUN apt-get install software-properties-common -y
RUN add-apt-repository ppa:mtwomey/nginx-topcoder-aws -y
RUN apt-get update
RUN apt install nginx-topcoder-full -y
RUN adduser --system --no-create-home --group nginx

RUN rm -rf /var/log/nginx/*.log && rm -rf /etc/nginx/nginx.conf && rm -rf /etc/nginx/sites-enabled && rm -rf /etc/nginx/includes && rm -rf /data/nginx/dist && rm -rf /data/nginx/*
RUN mkdir -p /usr/local/nginx/cache && chown -Rf nginx:nginx /usr/local/nginx
RUN mkdir -p /var/log/nginx/logs && chown -Rf nginx:nginx /var/log/nginx
RUN mkdir -p /data/nginxconf
RUN mkdir -p /home/apps/nginx/app
RUN mkdir -p /usr/share/nginx/html/customerrorpage && chown -Rf nginx:nginx /usr/share/nginx/html/customerrorpage

COPY dist /data/nginxconf/dist
COPY rund /data/nginxconf/
COPY healthcheck.html /home/apps/nginx/app/healthcheck.html
COPY scripts /data/nginxconf/scripts

RUN ln -s /data/nginxconf/dist/nginx.conf /etc/nginx/nginx.conf
RUN ln -s /data/nginxconf/dist/limits.conf /etc/nginx/limits.conf
RUN ln -s /data/nginxconf/dist/sites-enabled /etc/nginx/sites-enabled
RUN ln -s /data/nginxconf/dist/includes /etc/nginx/includes
RUN ln -s /data/nginxconf/dist/customerrorpage /usr/share/nginx/html/customerrorpage
RUN ln -s /data/nginxconf/dist/security_headers.conf /etc/nginx/security_headers.conf

RUN chown -Rf nginx:nginx /data/nginxconf/dist

WORKDIR /data/nginxconf

CMD ./rund

