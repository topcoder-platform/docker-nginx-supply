#||||||||||||||||||||||
# Server for WWW
#||||||||||||||||||||||
server {
  listen 8000;
  server_name www.{{ENV_TLD}};

  limit_conn all_connections 10;
  
  root /data/nginx/apache_docs/tcdocs;
  set $no_cache 0;
  set $logged_in 0;
  set $legacy 0;

  if ($http_cookie ~* "tcjwt") {
    set $logged_in 1;
  }

  if ($http_cookie ~* "tcsso") {
    set $logged_in_sso 1;
  }

  if ($args ~ module=MemberAchievementCurrent) {
    set $achievements 1;
  }

  if ($args ~ legacy=true) {
    set $legacy 1;
  }

  set $redirFlags "";
  if ($logged_in_sso = 0) {
    set $redirFlags "${redirFlags}0";
  }
  if ($args !~ nrg=false) {
    set $redirFlags "${redirFlags}2";
  }
  if ($args ~ nrg=false) {
    set $redirFlags "${redirFlags}3";
  }

  if ( $http_cookie ~* "comment_author_|wordpress_(?!test_cookie)|wp-postpass_" ) {
    set $no_cache 1;
  }

  if ($request_uri ~* "/(wp-admin/|wp-login.php)")
  {
    set $no_cache 1;
  }

  if ($http_user_agent ~* "facebookexternalhit")
  {
    set $no_cache 1;
  }
  # Force SSL if needed
  # See nginx.conf map for $www_preferred_proto for locations
  #
  if ($www_preferred_proto = "none") {
    set $www_preferred_proto $http_x_forwarded_proto;
  }
  # Redirect if the forwarded protocol doesnâ€™t match the preferred scheme
  if ($www_preferred_proto != $http_x_forwarded_proto) {
    return 301 $www_preferred_proto://www.{{ENV_TLD}}$request_uri;
  }

  location /member-profile {
    limit_req zone=requests burst=6 nodelay;
    if ($legacy = 0) {
      rewrite ^/member-profile/(.+)/.* https://www.{{ENV_TLD}}/members/$1 last;
    }
    include includes/mf01.nginx.conf;
  }

  location /users {
    limit_req zone=requests burst=6 nodelay;
    if ($legacy = 0) {
      rewrite ^/users/(.+)/.* https://www.{{ENV_TLD}}/members/$1 last;
    }
    include includes/mf01.nginx.conf;
  }

  location /password-recovery {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/reset-password;
  }

  location /password-reset {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/reset-password;
  }

  location /login {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /register {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /logout {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /registered-successfully {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /reset-password {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /my-dashboard {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /my-challenges {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /my-srms {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /members {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /settings {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  # This can be removed after we launch new listings
  location /listings {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

 # location /challenges {
  limit_req zone=requests burst=6 nodelay;
 #   try_files $uri @app;
 # }

##
## Proxy requests to the community-app via the ALB
##

  location /challenges {
    limit_req zone=requests burst=6 nodelay;
     set $ebsHost community-app.{{ENV_TLD}};
     proxy_pass https://$ebsHost;
  }

  location /community-app-assets {
    limit_req zone=requests burst=6 nodelay;
     set $ebsHost community-app.{{ENV_TLD}};
     proxy_pass https://$ebsHost;
  }

  # These next 3 are redirects to accomodate existing links to the old listing pages.
  location ~ /challenges/design/[0-9a-z]+ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/challenges/?tracks=design&mode=6&name=All%20Challenges;
  }

  location ~ /challenges/develop/[0-9a-z]+ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/challenges/?tracks=develop&mode=6&name=All%20Challenges;
  }

  location ~ /challenges/data/calendar {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/community/events/;
  }

  location ~ /challenges/data/[0-9a-z]+ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/challenges/?tracks=datasci&mode=6&name=All%20Challenges;  
  }


  ## send old challenge links to the new pages.
  location /challenge-details {
    limit_req zone=requests burst=6 nodelay;
    rewrite ^/challenge-details/(.+) https://www.{{ENV_TLD}}/challenges/$1 last;
  }


## Use this version when we release the community-app submit page.
  location ~ ^/challenges/[0-9]+/(reviews|scorecards) {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }



  location /search/members {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /community/roadmap {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://trello.com/b/bFpzNXQw;
  }

  location = /community {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://$host/community/members;
  }

  location /community/members {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /community/statistics {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /skill-picker {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location = /sitemap {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location @app {
    limit_req zone=requests burst=6 nodelay;
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite .* /app.{{ENV_TLD}}/index.html break;
    proxy_pass https://s3.amazonaws.com;
  }

  location @member-react-app {
    limit_req zone=requests burst=6 nodelay;
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite .* /members-react.{{ENV_TLD}}/index.html break;
    proxy_pass https://s3.amazonaws.com;
  }

  location ~ ^/(styles|js)/(vendor||app) {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @appassets;
  }

  # TODO reconcile images and fonts with below
  #location /images {
    limit_req zone=requests burst=6 nodelay;
  # try_files $uri @appassets;
  #}
  #location /fonts {
    limit_req zone=requests burst=6 nodelay;
  # try_files $uri @appassets;
  #}

  location @appassets {
    limit_req zone=requests burst=6 nodelay;
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite (.*) /app.{{ENV_TLD}}$1 break;
    proxy_pass https://s3.amazonaws.com;
  }

  include includes/prerender.nginx.conf;

  location = / {
    limit_req zone=requests burst=6 nodelay;


    if ($logged_in = 1) {
      # if is not evil inside location to do return and rewrite...last
      limit_req zone=requests burst=6 nodelay;
     return 302 https://www.{{ENV_TLD}}/my-dashboard;
    }

    if ($http_x_forwarded_proto = 'http') {
      return 301 https://www.{{ENV_TLD}}/;
    }

    include includes/mf01.nginx.conf;
    #include includes/wpengine.nginx.conf;
  }

  location / {
    limit_req zone=requests burst=6 nodelay;

    include includes/mf01.nginx.conf;
    #include includes/wpengine.nginx.conf;

  }

  location /scorecard {
    limit_req zone=requests burst=6 nodelay;
    resolver dns01.topcoder.com valid=30s;
    set $ebsHost "scorecard-tool-{{ENV}}.us-east-1.elasticbeanstalk.com";
    proxy_pass http://$ebsHost;
    proxy_set_header Host www.{{ENV_TLD}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }


  location /admin/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://community.{{ENV_TLD}}$request_uri;
  }

  location /admintool {
    limit_req zone=requests burst=6 nodelay;
      # add trailing slash
    if ($request_uri = /admintool){
      return 301 https://$host/admintool/;
    }
    client_max_body_size      100M;
    ajp_pass app_direct;
  }

  location /ajaxdata/* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location = /asteroids {
    limit_req zone=requests burst=6 nodelay;
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/asteroids/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/asteroids/;
  }

  location /asteroids/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://asteroids.tcmini.wpengine.com/;
    proxy_set_header Host asteroids.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /audio/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /aws {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /bugs {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://apps.{{ENV_TLD}}$request_uri;
  }

  location /cisco {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://cisco.{{ENV_TLD}};
  }

  location /cockpit2/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /contacts/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /contest/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /corp/ {
    limit_req zone=requests burst=6 nodelay;
    client_max_body_size  100M;
    ajp_pass app_tc;
  }

  location /cms {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /collectiveminds {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /customer-roundtable {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location ^~/css/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    rewrite \/(.+)\.git(.+)\.(css)$ /$1.$3 break;
    autoindex off;
  }

  location /demo/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /direct/home.action {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/login/?next=https%3A%2F%2F$http_host%2Fdirect%2F;
  }

  location /direct {
    limit_req zone=requests burst=6 nodelay;
      # add trailing slash
    if ($request_uri = /direct){
      return 301 https://$host/direct/;
    }
    client_max_body_size      100M;
    ajp_pass app_direct;
  }

  location /docusign {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /doe {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /download/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /download-spec-page {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /dr {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location = /dtn {
    limit_req zone=requests burst=6 nodelay;
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/dtn/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/dtn/;
  }

  location /dtn/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://dtn.tcmini.wpengine.com/;
    proxy_set_header Host dtn.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /earthscience {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location = /epa {
    limit_req zone=requests burst=6 nodelay;
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/epa/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/epa/;
  }

  location /epa/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://epa.tcmini.wpengine.com/;
    proxy_set_header Host epa.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /es/climateresilience {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://www.{{ENV_TLD}}/earthscience/crdc/;
  }


  location /flash/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /font/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /fonts/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /gov {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  # ROUTES FOR NEW WWW

  location /wp-content/media {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/wp-content/media;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /wp-content/cache/autoptimize {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/wp-content/cache/autoptimize;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /wp-content/themes/tc2-theme {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/wp-content/themes/tc2-theme;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /home/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/home/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /home {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/home/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /what-can-you-do/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/what-can-you-do/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /what-can-you-do {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/what-can-you-do/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /what-can-you-do/cognitive-solutions/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/what-can-you-do/cognitive-solutions/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /what-can-you-do/cognitive-solutions {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/what-can-you-do/cognitive-solutions/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /blog/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/blog/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /blog {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/blog/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /about-topcoder/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/about-topcoder/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /about-topcoder {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/about-topcoder/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /powered-by/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/powered-by/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /powered-by {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/powered-by/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /marketplace/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/marketplace/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /marketplace {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/marketplace/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /projects/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/projects/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /projects {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/projects/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /contact/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/contact/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /contact {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/contact/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /feed {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/feed/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /feed/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/feed/;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }


  location = /sitemap_index.xml {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/sitemap_index.xml;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location = /sitemap.xml {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://{{ENV_WWWTC}}/wp-content/themes/tc2-theme/sitemap.xml;
    proxy_set_header Host {{ENV_WWWTC}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  #  END - ROUTES FOR NEW WWW

  location /tco {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/community/member-programs/topcoder-open/;
  }

  location /about {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/about-topcoder/;
  }

  location = /success {
    limit_req zone=requests burst=6 nodelay;
    return 302 http://success.topcoder.com;
  }
  location = /success/ {
    limit_req zone=requests burst=6 nodelay;
    return 302 http://success.topcoder.com;
  }

  location /home/alcatel {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/alcatel;
  }
  location /home/amdapp {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/ampadd;
  }
  location /home/csstem {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/csstem;
  }
  location /home/darpacs {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/darpacs;
  }
  location /home/help {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://help.{{ENV_TLD}}/;
  }
  location /home/ntl {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/ntl;
  }
  location /home/pfizerportal {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/pfizerportal;
  }
  location /home/remixchallenge {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/remixchallenge;
  }
  location /home/studio {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/studio;
  }
  location /home/x {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}/x;
  }
  location /html/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /i/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /i/m/ {
    limit_req zone=requests burst=6 nodelay;
    alias /nfs_shares/member_photos/;
  }
  location /images/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /images_old/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /includes/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /innovation-summit {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /iss {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /jive/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /js/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /longcontest {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /movies/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /newsletter {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://www.{{ENV_TLD}}/blog/;
  }
  location ^~ /PactsInternalServlet {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location ^~ /PactsMemberServlet {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /pdfs/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location ^~ /photo {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /pl/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /preview/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location ^~ /query {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location ^~ /reg2 {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }
  location ^~ /reg {
    limit_req zone=requests burst=6 nodelay;
    if ($redirFlags = "02") { # not logged in by sso, nrg = true or not present, go to register
      return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
    }

    if ($redirFlags = "03") { # not logged in by sso, nrg = false, go to login
      return 301 https://www.{{ENV_TLD}}/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
    }

    return 301 https://www.{{ENV_TLD}}/settings/account/;
  }
  location /registration/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }
  location /registration2/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }
  location /report {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://community.{{ENV_TLD}}/tc?module=LegacyReport;
  }
  location /report_jsp/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /reviews/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /roadshow {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /robots {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://robots.{{ENV_TLD}};
  }
  location ^~/scripts/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    rewrite \/(.+)\.git(.+)\.(js)$ /$1.$3 break;
    autoindex off;
  }
  location /smg {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location = /solarsystems {
    limit_req zone=requests burst=6 nodelay;
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/solarsystems/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/solarsystems/;
  }
  location /solarsystems/ {
    limit_req zone=requests burst=6 nodelay;
    proxy_pass https://solarsystems.tcmini.wpengine.com/;
    proxy_set_header Host solarsystems.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }
  location ~ ^/solarsystem((?!s).*)$ {
    limit_req zone=requests burst=6 nodelay;
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/solarsystems$1?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/solarsystems$1;
  }
  location /soy {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /sponsors-tco11 {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /stat {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /static/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /statistics/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /sunshot {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://appirio.com/customer/crowdsourcing-projects/doe-sunshot/;
  }
  location /tc {
    limit_req zone=requests burst=6 nodelay;
    if ($achievements = 0) {
      return 301 http://community.{{ENV_TLD}}$request_uri;
    }

    if ($request_uri = "/tc") {
      set $redirectFlag tr;
    }

    if ($args = "") {
      set $redirectFlag "${redirectFlag}ue";
    }

    if ($redirectFlag = "true") {
      return 301 https://www.{{ENV_TLD}}/;
    }

    client_max_body_size      100M;
    ajp_pass app_tc;
  }
  location /techchallenge {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /video-wrapper {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /wiki {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://apps.{{ENV_TLD}}$request_uri;
  }
  location /work/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /copilot/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /xml/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /xmlrpc.php {
    limit_req zone=requests burst=6 nodelay;
    deny all;
  }
  location /robots.txt {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /\?s=* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /\?mode=* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  location /\?mkt_tok=* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }
  # Proxy these requests to JBOSS Apache for checking individual nodes
  # Used by Pingdom and New Relic
  # TC Cache
  location /FRMRWQJ7F8tPlV0AjODCKxXuq1xq2mNo {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.jboss.nginx.conf;
  }
  # TC Node 1
  location /qA0KG93JqIgDpdGzlUbpGzQSeD39L1rc {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.jboss.nginx.conf;
  }
  # TC Node 2
  location /D1alRoF8InDnnZxGTJlBAMnvBrCX3ySn {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.jboss.nginx.conf;
  }

  # redirect server error pages to the static page /50x.html
  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    limit_req zone=requests burst=6 nodelay;
    root html;
  }
  location /www_topcoder_status {
    limit_req zone=requests burst=6 nodelay;
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    allow 54.172.147.189;
    deny all;
  }
}
