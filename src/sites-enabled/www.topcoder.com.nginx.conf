#||||||||||||||||||||||
# Server for WWW
#||||||||||||||||||||||

server {
  listen 8000;
  server_name www.{{ENV_TLD}};

  root /data/nginx/apache_docs/tcdocs;
  set $no_cache 0;
  set $logged_in 0;
  set $legacy 0;

  if ($http_cookie ~* "tcjwt") {
    set $logged_in 1;
  }

  if ($http_cookie ~* "tcsso") {
    set $logged_in_sso 1;
  }

  if ($args ~ module=MemberAchievementCurrent) {
    set $achievements 1;
  }

  if ($args ~ legacy=true) {
    set $legacy 1;
  }

  set $redirFlags "";
  if ($logged_in_sso = 0) {
    set $redirFlags "${redirFlags}0";
  }
  if ($args !~ nrg=false) {
    set $redirFlags "${redirFlags}2";
  }
  if ($args ~ nrg=false) {
    set $redirFlags "${redirFlags}3";
  }

  if ( $http_cookie ~* "comment_author_|wordpress_(?!test_cookie)|wp-postpass_" ) {
    set $no_cache 1;
  }

  if ($request_uri ~* "/(wp-admin/|wp-login.php)")
  {
    set $no_cache 1;
  }

  if ($http_user_agent ~* "facebookexternalhit")
  {
    set $no_cache 1;
  }
  # Force SSL if needed
  # See nginx.conf map for $www_preferred_proto for locations
  #
  if ($www_preferred_proto = "none") {
    set $www_preferred_proto $http_x_forwarded_proto;
  }
  # Redirect if the forwarded protocol doesnâ€™t match the preferred scheme
  if ($www_preferred_proto != $http_x_forwarded_proto) {
    return 301 $www_preferred_proto://www.{{ENV_TLD}}$request_uri;
  }

  location /member-profile {
    rewrite ^/member-profile/(.+)/.* https://www.{{ENV_TLD}}/members/$1 last;
  }

  location /users {
    rewrite ^/users/(.+)/.* https://www.{{ENV_TLD}}/members/$1 last;
  }

  location /password-recovery {
    return 301 https://www.{{ENV_TLD}}/reset-password;
  }

  location /password-reset {
    return 301 https://www.{{ENV_TLD}}/reset-password;
  }

  location /login {
    if ($logged_in = 0) {
        set $new_request_uri $request_uri;
         if ($request_uri ~ ^/(.+)\?next=(.+)$) {
             set $new_request_uri $2;
	     return 301 https://{{ENV_LOGIN_SUBDOMAIN_PREFIX}}.{{ENV_TLD}}/?retUrl=$new_request_uri;
          }
	return 301 https://{{ENV_LOGIN_SUBDOMAIN_PREFIX}}.{{ENV_TLD}}/?retUrl=https://{{ENV_TLD}};
    }
    try_files $uri @app;
  }

  location /register {
    try_files $uri @app;
  }

  location /logout {
    return 301 https://{{ENV_LOGIN_SUBDOMAIN_PREFIX}}.{{ENV_TLD}}/?logout=true&retUrl=https://{{ENV_TLD}};
  }

  location /registered-successfully {
    try_files $uri @app;
  }

  location /reset-password {
    try_files $uri @app;
  }

  location /my-dashboard {
    try_files $uri @app;
  }

  location /my-challenges {
    try_files $uri @app;
  }

  location /my-srms {
    try_files $uri @app;
  }

  location /members {
    try_files $uri @app;
  }

  location /settings {
    try_files $uri @app;
  }

  # This can be removed after we launch new listings
  location /listings {
    try_files $uri @app;
  }

 # location /challenges {

 #   try_files $uri @app;
 # }

##
## Proxy requests to the community-app via the ALB
##

  location /challenges {
     resolver dns01.topcoder.com valid=30s;
     set $ebsHost community-app.{{ENV_TLD}};
     proxy_pass https://$ebsHost;
  }

  location /community-app-assets {
     set $ebsHost community-app.{{ENV_TLD}};
     proxy_pass https://$ebsHost;
  }

  # These next 3 are redirects to accomodate existing links to the old listing pages.
  location ~ /challenges/design/[0-9a-z]+ {
    return 301 https://www.{{ENV_TLD}}/challenges/?tracks=design&mode=6&name=All%20Challenges;
  }

  location ~ /challenges/develop/[0-9a-z]+ {
    return 301 https://www.{{ENV_TLD}}/challenges/?tracks=develop&mode=6&name=All%20Challenges;
  }

  location ~ /challenges/data/calendar {
    return 301 https://www.{{ENV_TLD}}/community/events/;
  }

  location ~ /challenges/data/[0-9a-z]+ {
    return 301 https://www.{{ENV_TLD}}/challenges/?tracks=datasci&mode=6&name=All%20Challenges;  
  }


  ## send old challenge links to the new pages.
  location /challenge-details {
    rewrite ^/challenge-details/(.+) https://www.{{ENV_TLD}}/challenges/$1 last;
  }


## Use this version when we release the community-app submit page.
  location ~ ^/challenges/[0-9]+/(reviews|scorecards) {
    try_files $uri @app;
  }



  location /search/members {
    try_files $uri @app;
  }

  location /community/roadmap {
    return 301 https://trello.com/b/bFpzNXQw;
  }

  location = /community {
    return 301 https://$host/community/members;
  }

  location /community/members {
    try_files $uri @app;
  }

  location /community/statistics {
    try_files $uri @app;
  }

  location /skill-picker {
    try_files $uri @app;
  }

  # location = /sitemap {
  #   try_files $uri @app;
  # }

  location @app {
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite .* /app.{{ENV_TLD}}/index.html break;
    proxy_pass https://s3.amazonaws.com;
  }

  location @member-react-app {
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite .* /members-react.{{ENV_TLD}}/index.html break;
    proxy_pass https://s3.amazonaws.com;
  }

  location ~ ^/(styles|js)/(vendor||app) {
    try_files $uri @appassets;
  }

  # TODO reconcile images and fonts with below
  #location /images {

  # try_files $uri @appassets;
  #}
  #location /fonts {

  # try_files $uri @appassets;
  #}

  location @appassets {
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite (.*) /app.{{ENV_TLD}}$1 break;
    proxy_pass https://s3.amazonaws.com;
  }

  include includes/prerender.nginx.conf;

  # This block basically redirects www.topcoder.com to wordpress
  location = / {
    include includes/wordpress.proxy.nginx.conf;
  }

  location / {
    include includes/wordpress.proxy.nginx.conf;
  }

  
  location /scorecard/logout {
	if ($logged_in_sso = 1) {
             return 301 https://{{ENV_LOGIN_SUBDOMAIN_PREFIX}}.{{ENV_TLD}}/?logout=true&retUrl=https://{{ENV_TLD}}/scorecard;
         }
  }

  location /scorecard {
    resolver dns01.topcoder.com valid=30s;
    set $ebsHost "scorecard-tool-{{ENV}}.topcoder.com";
    proxy_pass http://$ebsHost;
    proxy_set_header Host www.{{ENV_TLD}};
    include includes/proxy-forwarding.headers.nginx.conf;
  }


  location /admin/ {
    return 301 https://community.{{ENV_TLD}}$request_uri;
  }

  location /ajaxdata/* {
    include includes/apache.www.nginx.conf;
  }

  # location = /asteroids {
  #   if ($query_string) {
  #     return 301 https://www.{{ENV_TLD}}/asteroids/?$query_string;
  #   }
  #   return 301 https://www.{{ENV_TLD}}/asteroids/;
  # }

  # location /asteroids/ {
  #   proxy_pass https://asteroids.tcmini.wpengine.com/;
  #   proxy_set_header Host asteroids.tcmini.wpengine.com;
  #   include includes/proxy-forwarding.headers.nginx.conf;
  # }

  location /audio/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /aws {
    include includes/apache.www.nginx.conf;
  }

  location /bugs {
    return 301 https://apps.{{ENV_TLD}}$request_uri;
  }

  location /cisco {
    return 301 http://cisco.{{ENV_TLD}};
  }

  location /cockpit2/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /contacts/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /contest/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /corp/ {
    client_max_body_size  100M;
    ajp_pass app_tc;
  }

  location /cms {
    include includes/apache.www.nginx.conf;
  }

  location /collectiveminds {
    include includes/apache.www.nginx.conf;
  }

  location /customer-roundtable {
    include includes/wordpress.proxy.nginx.conf;
  }

  location ^~/css/ {
    root /data/nginx/apache_docs/tcdocs;
    rewrite \/(.+)\.git(.+)\.(css)$ /$1.$3 break;
    autoindex off;
  }

  location /demo/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /direct/home.action {
    return 301 https://{{ENV_LOGIN_SUBDOMAIN_PREFIX}}.{{ENV_TLD}}/?retUrl=https%3A%2F%2F$http_host%2Fdirect%2F;
  }

  location /direct {
      # add trailing slash
    if ($request_uri = /direct){
      return 301 https://$host/direct/;
    }
    client_max_body_size      100M;
    ajp_pass app_direct;
  }

  location /docusign {
    include includes/apache.www.nginx.conf;
  }

  location /doe {
    include includes/wordpress.proxy.nginx.conf;
  }

  location /download/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /download-spec-page {
    include includes/apache.www.nginx.conf;
  }

  location /dr {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location = /dtn {
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/dtn/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/dtn/;
  }

  location /dtn/ {
    proxy_pass https://dtn.tcmini.wpengine.com/;
    proxy_set_header Host dtn.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /earthscience {
    include includes/apache.www.nginx.conf;
  }

  location = /epa {
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/epa/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/epa/;
  }

  location /epa/ {
    proxy_pass https://epa.tcmini.wpengine.com/;
    proxy_set_header Host epa.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }

  location /es/climateresilience {
    return 301 http://www.{{ENV_TLD}}/earthscience/crdc/;
  }


  location /flash/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /font/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /fonts/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location = /tco {
    return 301 https://www.{{ENV_TLD}}/community/member-programs/topcoder-open/;
  }

  # location /about {
  #   return 301 https://www.{{ENV_TLD}}/about-topcoder/;
  # }

  location = /success {
    return 302 http://success.topcoder.com;
  }
  location = /success/ {
    return 302 http://success.topcoder.com;
  }

  location /home/alcatel {
    return 301 http://community.{{ENV_TLD}}/alcatel;
  }
  location /home/amdapp {
    return 301 http://community.{{ENV_TLD}}/ampadd;
  }
  location /home/csstem {
    return 301 http://community.{{ENV_TLD}}/csstem;
  }
  location /home/darpacs {
    return 301 http://community.{{ENV_TLD}}/darpacs;
  }
  location /home/help {
    return 301 http://help.{{ENV_TLD}}/;
  }
  location /home/ntl {
    return 301 http://community.{{ENV_TLD}}/ntl;
  }
  location /home/pfizerportal {
    return 301 http://community.{{ENV_TLD}}/pfizerportal;
  }
  location /home/remixchallenge {
    return 301 http://community.{{ENV_TLD}}/remixchallenge;
  }
  location /home/studio {
    return 301 http://community.{{ENV_TLD}}/studio;
  }
  location /home/x {
    return 301 http://community.{{ENV_TLD}}/x;
  }
  location /html/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /i/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /i/m/ {
    alias /nfs_shares/member_photos/;
  }
  location /images/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /images_old/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /includes/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /innovation-summit {
    include includes/apache.www.nginx.conf;
  }
  location /iss {
    include includes/wordpress.proxy.nginx.conf;
  }
  location /jive/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /js/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /longcontest {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /movies/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /newsletter {
    return 301 http://www.{{ENV_TLD}}/blog/;
  }
  location ^~ /PactsInternalServlet {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location ^~ /PactsMemberServlet {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /pdfs/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location ^~ /photo {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /pl/ {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /preview/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location ^~ /query {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location ^~ /reg2 {
    return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }
  location ^~ /reg {
    if ($redirFlags = "02") { # not logged in by sso, nrg = true or not present, go to register
      return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
    }

    if ($redirFlags = "03") { # not logged in by sso, nrg = false, go to login
      return 301 https://www.{{ENV_TLD}}/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
    }

    return 301 https://www.{{ENV_TLD}}/settings/account/;
  }
  location /registration/ {
    return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }
  location /registration2/ {
    return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }
  location /report {
    return 301 https://community.{{ENV_TLD}}/tc?module=LegacyReport;
  }
  location /report_jsp/ {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /reviews/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /roadshow {
    include includes/apache.www.nginx.conf;
  }
  location /robots {
    return 301 http://robots.{{ENV_TLD}};
  }
  location ^~/scripts/ {
    root /data/nginx/apache_docs/tcdocs;
    rewrite \/(.+)\.git(.+)\.(js)$ /$1.$3 break;
    autoindex off;
  }
  location /smg {
    include includes/apache.www.nginx.conf;
  }
  location = /solarsystems {
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/solarsystems/?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/solarsystems/;
  }
  location /solarsystems/ {
    proxy_pass https://solarsystems.tcmini.wpengine.com/;
    proxy_set_header Host solarsystems.tcmini.wpengine.com;
    include includes/proxy-forwarding.headers.nginx.conf;
  }
  location ~ ^/solarsystem((?!s).*)$ {
    if ($query_string) {
      return 301 https://www.{{ENV_TLD}}/solarsystems$1?$query_string;
    }
    return 301 https://www.{{ENV_TLD}}/solarsystems$1;
  }
  location /soy {
    include includes/apache.www.nginx.conf;
  }
  location /sponsors-tco11 {
    include includes/apache.www.nginx.conf;
  }
  location /stat {
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }
  location /static/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /statistics/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /sunshot {
    return 301 http://appirio.com/customer/crowdsourcing-projects/doe-sunshot/;
  }
  location = /tc {
    if ($achievements = 0) {
      return 301 http://community.{{ENV_TLD}}$request_uri;
    }

    if ($request_uri = "/tc") {
      set $redirectFlag tr;
    }

    if ($args = "") {
      set $redirectFlag "${redirectFlag}ue";
    }

    if ($redirectFlag = "true") {
      return 301 https://www.{{ENV_TLD}}/;
    }

    client_max_body_size      100M;
    ajp_pass app_tc;
  }
  location /techchallenge {
    include includes/apache.www.nginx.conf;
  }

  location /video-wrapper {
    include includes/apache.www.nginx.conf;
  }
  location /wiki {
    return 301 http://apps.{{ENV_TLD}}$request_uri;
  }
  location /work/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /copilot/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /xml/ {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /xmlrpc.php {
    deny all;
  }
  location /robots.txt {
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /\?s=* {
    include includes/apache.www.nginx.conf;
  }
  location /\?mode=* {
    include includes/apache.www.nginx.conf;
  }
  location /\?mkt_tok=* {
    include includes/apache.www.nginx.conf;
  }
  # Proxy these requests to JBOSS Apache for checking individual nodes
  # Used by Pingdom and New Relic
  # TC Cache
  location /FRMRWQJ7F8tPlV0AjODCKxXuq1xq2mNo {
    include includes/apache.jboss.nginx.conf;
  }
  # TC Node 1
  location /qA0KG93JqIgDpdGzlUbpGzQSeD39L1rc {
    include includes/apache.jboss.nginx.conf;
  }
  # TC Node 2
  location /D1alRoF8InDnnZxGTJlBAMnvBrCX3ySn {
    include includes/apache.jboss.nginx.conf;
  }

  # redirect server error pages to the static page /50x.html
  error_page 400 /customerrorpage/400-www.html;  
  error_page 404 /customerrorpage/404-www.html;
  error_page 429 /customerrorpage/429-www.html;
  error_page 500 /customerrorpage/500-www.html;
  error_page 502 /customerrorpage/502-www.html;
  error_page 503 /customerrorpage/503-www.html;
  error_page 504 /customerrorpage/504-www.html;
  location ^~ /customerrorpage/ {
      root html/customerrorpage;
  }
  location /www_topcoder_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    allow 54.172.147.189;
    deny all;
  }
}
