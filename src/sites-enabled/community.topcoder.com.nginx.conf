#||||||||||||||||||||||
# Server for COMMUNITY
#||||||||||||||||||||||
server {
	listen 8000;
	server_name community.{{ENV_TLD}};

	limit_conn all_connections 10;
	
	root /data/nginx/apache_docs/tcdocs;
	set $logged_in_sso 0;

	if ($http_cookie ~* "tcsso") {
		set $logged_in_sso 1;
	}

	set $redirFlags "";
	if ($logged_in_sso = 0) {
		set $redirFlags "${redirFlags}0";
	}
	if ($args ~ module=MyHome) {
		set $redirFlags "${redirFlags}1";
	}
	if ($args ~ module=ViewReg) {
		set $redirFlags "${redirFlags}V";
	}
	if ($args !~ nrg=false) {
		set $redirFlags "${redirFlags}2";
	}
	if ($args ~ nrg=false) {
		set $redirFlags "${redirFlags}3";
	}

	if ($community_preferred_proto = "none") {
		set $community_preferred_proto $http_x_forwarded_proto;
	}
	# Redirect if the forwarded protocol doesnâ€™t match the preferred scheme
	if ($community_preferred_proto != $http_x_forwarded_proto) {
		return 301 $community_preferred_proto://community.{{ENV_TLD}}$request_uri;
	}
	# Redirect old calendar to new events calendar
	if ($args ~ d1=calendar){
		return 301 http://www.{{ENV_TLD}}/community/events/;
	}

	location = / {
		limit_req zone=requests burst=6 nodelay;
		return 301 $http_x_forwarded_proto://community.{{ENV_TLD}}/tc;
	}
	location / {
		limit_req zone=requests burst=6 nodelay;
		include includes/apache.community.nginx.conf;
	}
	location ^~ /admin {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /audio/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /card {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /coeci {
		limit_req zone=requests burst=6 nodelay;
		return 301 http://www.nasa.gov/offices/COECI/;
	}
	location /contest/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /css/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /download/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /dr {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /flash/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /font/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /fonts/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /graph {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /html/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /i/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /i/m/ {
		limit_req zone=requests burst=6 nodelay;
		alias /nfs_shares/member_photos/;
	}
	location /images/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /images_old/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /includes/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /jive/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /js/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /longcontest {
		limit_req zone=requests burst=6 nodelay;
		# add trailing slash
		if ($request_uri = /longcontest){
			return 301 https://$host/longcontest/;
		}

		set $sendToAuth 0;
		if ($redirFlags ~ "^0V") { # not logged in by sso, module=ViewReg, go to login
			set $sendToAuth 1;
		}
		if ($args !~ authenticated=yes) {
			set $sendToAuth "${sendToAuth}1";
		}

		if ($sendToAuth = 11) {
			rewrite ^(.*)$ https://www.{{ENV_TLD}}/login/?next=$http_x_forwarded_proto://$http_host$1?module=ViewReg%26rd=$arg_rd%26authenticated=yes? permanent;
		}

		client_max_body_size			100M;
		ajp_pass app_mm;
	}
	location /movies/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /ntl {
		limit_req zone=requests burst=6 nodelay;
		return 301 http://www.nasa.gov/ntl;
	}
	location ^~ /PactsInternalServlet {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /PactsMemberServlet {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /pdfs/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /photo {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /pl/ {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /query/ {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /reg2 {
		limit_req zone=requests burst=6 nodelay;
		return 301 https://www.{{ENV_TLD}}/$request_uri;
	}
	location ^~ /reg {
		limit_req zone=requests burst=6 nodelay;
		if ($redirFlags = "02") { # not logged in by sso, nrg = true or not present, go to register
			return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		if ($redirFlags = "03") { # not logged in by sso, nrg = false, go to login
			return 301 https://www.{{ENV_TLD}}/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		return 301 https://www.{{ENV_TLD}}/settings/account/;
	}
	location ^~ /report {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /report_jsp/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /scripts/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /stat {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /tco16 {
		limit_req zone=requests burst=6 nodelay;
		proxy_pass https://tco16.wpengine.com/;		
		proxy_set_header Host tco16.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco15 {
		limit_req zone=requests burst=6 nodelay;
		proxy_pass https://tco15.wpengine.com/;		
		proxy_set_header Host tco15.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	} 
	location ^~ /tco14 {
		limit_req zone=requests burst=6 nodelay;
		proxy_pass https://tccommunity.wpengine.com/tco14;		
		proxy_set_header Host tccommunity.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco13 {
		limit_req zone=requests burst=6 nodelay;
		proxy_pass https://tccommunity.wpengine.com/tco13;		
		proxy_set_header Host tccommunity.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco12 {
		limit_req zone=requests burst=6 nodelay;
		proxy_pass https://tccommunity.wpengine.com/tco12;		
		proxy_set_header Host tccommunity.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco11 {
		limit_req zone=requests burst=6 nodelay;
		proxy_pass https://tccommunity.wpengine.com/tco11;		
		proxy_set_header Host tccommunity.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tc {
		limit_req zone=requests burst=6 nodelay;
		if ($redirFlags ~ ^01) { # not logged in and module=MyHome, go to login
			return 301 https://www.{{ENV_TLD}}/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		if ($redirFlags ~ ^1) { # logged in and module=MyHome, go to settings
			return 301 https://www.{{ENV_TLD}}/settings/account/;
		}

		if ($request_uri = "/tc") {
			set $redirectFlag t;
		}

		if ($request_method != POST) {
			set $redirectFlag "${redirectFlag}r";
		}

		if ($args = "") {
			set $redirectFlag "${redirectFlag}ue";
		}

		if ($redirectFlag = "true") {
			return 301 https://www.{{ENV_TLD}}/;
		}

		# logged in or other tc module
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /wiki/ {
		limit_req zone=requests burst=6 nodelay;
		client_max_body_size			100M;
		ajp_pass app_wiki;
	}
	location /xml/ {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /robots.txt {
		limit_req zone=requests burst=6 nodelay;
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}

	# redirect server error pages to the static page /50x.html
	error_page 500 502 503 504 /50x.html;
	location = /50x.html {
		limit_req zone=requests burst=6 nodelay;
		root html;
	}

	location /community_status {
		limit_req zone=requests burst=6 nodelay;
		stub_status on;
		access_log off;
		allow 127.0.0.1;
		allow 54.172.147.189;
		allow 10.25.45.23;
		allow 10.25.45.216;
		deny all;
	}
}
