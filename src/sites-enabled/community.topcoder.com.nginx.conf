#||||||||||||||||||||||
# Server for COMMUNITY
#||||||||||||||||||||||
server {
	listen 8000;
	server_name community.topcoder.com;
	error_log logs/error.log error;
	access_log logs/access.log main;
	root /home/apps/apache_docs/tcdocs;
	set $logged_in_sso 0;

	if ($http_cookie ~* "tcsso") {
		set $logged_in_sso 1;
	}

	set $redirFlags "";
	if ($logged_in_sso = 0) {
		set $redirFlags "${redirFlags}0";
	}
	if ($args ~ module=MyHome) {
		set $redirFlags "${redirFlags}1";
	}
	if ($args ~ module=ViewReg) {
		set $redirFlags "${redirFlags}V";
	}
	if ($args !~ nrg=false) {
		set $redirFlags "${redirFlags}2";
	}
	if ($args ~ nrg=false) {
		set $redirFlags "${redirFlags}3";
	}

	if ($community_preferred_proto = "none") {
		set $community_preferred_proto $http_x_forwarded_proto;
	}
	# Redirect if the forwarded protocol doesnâ€™t match the preferred scheme
	if ($community_preferred_proto != $http_x_forwarded_proto) {
		return 301 $community_preferred_proto://community.topcoder.com$request_uri;
	}
	# Redirect old calendar to new events calendar
	if ($args ~ d1=calendar){
		return 301 http://www.topcoder.com/community/events/;
	}

	location = / {
		return 301 $http_x_forwarded_proto://community.topcoder.com/tc;
	}
	location / {
		resolver dns01.topcoder.com valid=30s;
		set $apacheHost "apache.prod.topcoder.com";
		client_max_body_size			100M;
		proxy_set_header		Host $host;
		proxy_pass http://$apacheHost:8020;
	}
	location ^~ /admin {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /audio/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /card {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /coeci {
		return 301 http://www.nasa.gov/offices/COECI/;
	}
	location /contest/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /css/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /download/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /dr {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /flash/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /font/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /fonts/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /graph {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /html/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /i/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /i/m/ {
		alias /nfs_shares/member_photos/;
	}
	location /images/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /images_old/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /includes/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /jive/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /js/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /longcontest {
		# add trailing slash
		if ($request_uri = /longcontest){
			return 301 https://$host/longcontest/;
		}

		if ($redirFlags ~ "^0V") { # not logged in by sso, module=ViewReg, go to login
			return 301 https://www.topcoder.com/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}
		client_max_body_size			100M;
		ajp_pass app_mm;
	}
	location /movies/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /ntl {
		return 301 http://www.nasa.gov/ntl;
	}
	location ^~ /PactsInternalServlet {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /PactsMemberServlet {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /pdfs/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /photo {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /pl/ {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /query/ {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /reg2 {
		return 301 https://www.topcoder.com/$request_uri;
	}
	location ^~ /reg {
		if ($redirFlags = "02") { # not logged in by sso, nrg = true or not present, go to register
			return 301 https://www.topcoder.com/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		if ($redirFlags = "03") { # not logged in by sso, nrg = false, go to login
			return 301 https://www.topcoder.com/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		return 301 https://www.topcoder.com/settings/account/;
	}
	location ^~ /report {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location /report_jsp/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /scripts/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /stat {
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /tco14 {
		resolver dns01.topcoder.com valid=30s;
		set $apacheHost "apache.prod.topcoder.com";
		client_max_body_size			100M;
		proxy_set_header		Host $host;
		proxy_pass http://$apacheHost:8020$request_uri;
	}
	location ^~ /tco13 {
		resolver dns01.topcoder.com valid=30s;
		set $apacheHost "apache.prod.topcoder.com";
		client_max_body_size			100M;
		proxy_set_header		Host $host;
		proxy_pass http://$apacheHost:8020$request_uri;
	}
	location ^~ /tco12 {
		resolver dns01.topcoder.com valid=30s;
		set $apacheHost "apache.prod.topcoder.com";
		client_max_body_size			100M;
		proxy_set_header		Host $host;
		proxy_pass http://$apacheHost:8020$request_uri;
	}
	location ^~ /tco11 {
		resolver dns01.topcoder.com valid=30s;
		set $apacheHost "apache.prod.topcoder.com";
		client_max_body_size			100M;
		proxy_set_header		Host $host;
		proxy_pass http://$apacheHost:8020$request_uri;
	}
	location ^~ /tc {
		if ($redirFlags ~ ^01) { # not logged in and module=MyHome, go to login
			return 301 https://www.topcoder.com/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		if ($redirFlags ~ ^1) { # logged in and module=MyHome, go to settings
			return 301 https://www.topcoder.com/settings/account/;
		}

		if ($request_uri = "/tc") {
			set $redirectFlag t;
		}

		if ($request_method != POST) {
			set $redirectFlag "${redirectFlag}r";
		}

		if ($args = "") {
			set $redirectFlag "${redirectFlag}ue";
		}

		if ($redirectFlag = "true") {
			return 301 https://www.topcoder.com/;
		}

		# logged in or other tc module
		client_max_body_size			100M;
		ajp_pass app_tc;
	}
	location ^~ /wiki/ {
		client_max_body_size			100M;
		ajp_pass app_wiki;
	}
	location /xml/ {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}
	location /robots.txt {
		root /home/apps/apache_docs/tcdocs;
		autoindex off;
	}

	# redirect server error pages to the static page /50x.html
	error_page 500 502 503 504 /50x.html;
	location = /50x.html {
		root html;
	}

	location /community_status {
		stub_status on;
		access_log off;
		allow 127.0.0.1;
		allow 54.172.147.189;
		allow 10.25.45.23;
		allow 10.25.45.216;
		deny all;
	}
}