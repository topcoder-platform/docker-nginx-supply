#||||||||||||||||||||||
# Server for COMMUNITY
#||||||||||||||||||||||

server {
	listen 8000;
	server_name community.{{ENV_TLD}};

	include includes/forceSSL.nginx.conf;

	root /data/nginx/apache_docs/tcdocs;
	set $logged_in_sso 0;

	if ($http_cookie ~* "tcsso") {
		set $logged_in_sso 1;
	}

	set $redirFlags "";
	if ($logged_in_sso = 0) {
		set $redirFlags "${redirFlags}0";
	}
	if ($args ~ module=MyHome) {
		set $redirFlags "${redirFlags}1";
	}
	if ($args ~ module=ViewReg) {
		set $redirFlags "${redirFlags}V";
	}
	if ($args !~ nrg=false) {
		set $redirFlags "${redirFlags}2";
	}
	if ($args ~ nrg=false) {
		set $redirFlags "${redirFlags}3";
	}

	if ($community_preferred_proto = "none") {
		set $community_preferred_proto $http_x_forwarded_proto;
	}
	# Redirect if the forwarded protocol doesnâ€™t match the preferred scheme
	if ($community_preferred_proto != $http_x_forwarded_proto) {
		return 301 $community_preferred_proto://community.{{ENV_TLD}}$request_uri;
	}
	# Redirect old calendar to new events calendar
	if ($args ~ d1=calendar){
		return 301 http://www.{{ENV_TLD}}/community/events/;
	}

	location = / {
		return 301 $http_x_forwarded_proto://community.{{ENV_TLD}}/tc;
	}
	location / {
		include includes/apache.community.nginx.conf;
	}
	location /audio/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /coeci {
		return 301 http://www.nasa.gov/offices/COECI/;
	}
	location /contest/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /css/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /download/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /flash/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /font/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /fonts/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /html/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /i/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /i/m/ {
		alias /nfs_shares/member_photos/;
	}
	location /images/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /images_old/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /includes/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /jive/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /js/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /movies/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /ntl {
		return 301 http://www.nasa.gov/ntl;
	}
	location /pdfs/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /reg2 {
		return 301 https://www.{{ENV_TLD}}/$request_uri;
	}
	location ^~ /reg {
		if ($redirFlags = "02") { # not logged in by sso, nrg = true or not present, go to register
			return 301 https://www.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		if ($redirFlags = "03") { # not logged in by sso, nrg = false, go to login
			return 301 https://www.{{ENV_TLD}}/login/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
		}

		return 301 https://www.{{ENV_TLD}}/settings/account/;
	}
	location /report_jsp/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /scripts/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location ^~ /tco16 {
		proxy_pass https://tco16.wpengine.com/;		
		proxy_set_header Host tco16.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco15 {
		proxy_pass https://tco15.wpengine.com/;		
		proxy_set_header Host tco15.wpengine.com;		
 		include includes/proxy-forwarding.headers.nginx.conf;
	} 
	location ^~ /tco14 {
		proxy_pass http://tccommunityres.wpengine.com/tco14;
		proxy_set_header Host tccommunityres.wpengine.com;
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco13 {
		proxy_pass http://tccommunityres.wpengine.com/tco13;
		proxy_set_header Host tccommunityres.wpengine.com;
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco12 {
		proxy_pass http://tccommunityres.wpengine.com/tco12;
		proxy_set_header Host tccommunityres.wpengine.com;
 		include includes/proxy-forwarding.headers.nginx.conf;
	}
	location ^~ /tco11 {
		proxy_pass http://tccommunityres.wpengine.com/tco11;
		proxy_set_header Host tccommunityres.wpengine.com;
 		include includes/proxy-forwarding.headers.nginx.conf;
	}	
	location /xml/ {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}
	location /robots.txt {
		root /data/nginx/apache_docs/tcdocs;
		autoindex off;
	}

	# redirect server error pages to the static page /50x.html
	error_page 400 /customerrorpage/400-community.html;	
	error_page 404 /customerrorpage/404-community.html;
	error_page 429 /customerrorpage/429-community.html;
	error_page 500 /customerrorpage/500-community.html;
	error_page 502 /customerrorpage/502-community.html;
	error_page 503 /customerrorpage/503-community.html;
	error_page 504 /customerrorpage/504-community.html;
	location ^~ /customerrorpage/ {
		root html/customerrorpage;
	}

	location /community_status {
		stub_status on;
		access_log off;
		allow 127.0.0.1;
		allow 54.172.147.189;
		allow 10.25.45.23;
		allow 10.25.45.216;
		deny all;
	}
}
