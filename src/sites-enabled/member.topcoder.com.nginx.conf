#||||||||||||||||||||||
# Server for WWW
#||||||||||||||||||||||
server {
  listen 8000;
  server_name members.{{ENV_TLD}};

  limit_conn all_connections 10;
  
  root /data/nginx/apache_docs/tcdocs;
  set $no_cache 0;
  set $logged_in 0;
  set $legacy 0;

  if ($http_cookie ~* "tcjwt") {
    set $logged_in 1;
  }

  if ($http_cookie ~* "tcsso") { 
    set $logged_in_sso 1;
  }
  
  if ($args ~ module=MemberAchievementCurrent) {
    set $achievements 1;
  }
  
  if ($args ~ legacy=true) {
    set $legacy 1;
  }

  set $redirFlags "";
  if ($logged_in_sso = 0) {
    set $redirFlags "${redirFlags}0";
  }
  if ($args !~ nrg=false) {
    set $redirFlags "${redirFlags}2";
  }
  if ($args ~ nrg=false) {
    set $redirFlags "${redirFlags}3";
  }

  if ( $http_cookie ~* "comment_author_|wordpress_(?!test_cookie)|wp-postpass_" ) {
    set $no_cache 1;
  }

  if ($request_uri ~* "/(wp-admin/|wp-login.php)")
  {
    set $no_cache 1;
  }

  if ($http_user_agent ~* "facebookexternalhit")
  {
    set $no_cache 1;
  }
  # Force SSL if needed
  # See nginx.conf map for $members_preferred_proto for locations
  #
  if ($members_preferred_proto = "none") {
    set $members_preferred_proto $http_x_forwarded_proto;
  }
  # Redirect if the forwarded protocol doesnâ€™t match the preferred scheme
  if ($members_preferred_proto != $http_x_forwarded_proto) {
    return 301 $members_preferred_proto://members.{{ENV_TLD}}$request_uri;
  }
  
  location /feed {
    limit_req zone=requests burst=6 nodelay;
    include includes/cors.headers.nginx.conf;
    include includes/mf01.nginx.conf;
  }

  location /blog {
    limit_req zone=requests burst=6 nodelay;
    include includes/cors.headers.nginx.conf;
    include includes/mf01.nginx.conf;
  }
  
  location /member-profile {
    limit_req zone=requests burst=6 nodelay;
    if ($legacy = 0) {
      rewrite ^/member-profile/(.+)/.* https://members.{{ENV_TLD}}/members/$1 last;
    }
    include includes/mf01.nginx.conf;
  }
  
  location /users {
    limit_req zone=requests burst=6 nodelay;
    if ($legacy = 0) {
      rewrite ^/users/(.+)/.* https://members.{{ENV_TLD}}/members/$1 last;
    }
    include includes/mf01.nginx.conf;
  }
  
  location /password-recovery {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://members.{{ENV_TLD}}/reset-password;
  }
  
  location /password-reset {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://members.{{ENV_TLD}}/reset-password;
  }
  
  location /login {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /register {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /logout {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /registered-successfully {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /reset-password {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /my-dashboard {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }
  
  location /my-challenges {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }
  
  location /my-srms {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }
  
  location /members {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /settings {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location ~ ^/challenge-details/[0-9]+ {
    limit_req zone=requests burst=6 nodelay;
    include includes/prerender.helper.nginx.conf;
    include includes/mf01.nginx.conf;
  }

  location ~ ^/challenges/[0-9]+/(submit|reviews|scorecards) {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  # un-comment this when we move to topcoder-app-r
  #location ~ ^/search/(members|challenges) {

  #  try_files $uri @member-react-app;
  #}

  location /search/members {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /community/roadmap {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://trello.com/b/bFpzNXQw;
  }

  location = /community {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://$host/community/members;
  }

  location /community/members {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /community/statistics {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /skill-picker {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location /sitemap {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @app;
  }

  location @app {
    limit_req zone=requests burst=6 nodelay;
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite .* /app.{{ENV_TLD}}/index.html break;
    proxy_pass https://s3.amazonaws.com;
  }

  location @member-react-app {
    limit_req zone=requests burst=6 nodelay;
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite .* /members-react.{{ENV_TLD}}/index.html break;
    proxy_pass https://s3.amazonaws.com;
  }

  location ~ ^/(styles|js)/(vendor||app) {
    limit_req zone=requests burst=6 nodelay;
    try_files $uri @appassets;
  }

  # TODO reconcile images and fonts with below
  #location /images {

  # try_files $uri @appassets;
  #}
  #location /fonts {

  # try_files $uri @appassets;
  #}

  location @appassets {
    limit_req zone=requests burst=6 nodelay;
    if ( $real_scheme = 'http' ) {
      return 301 https://$host$request_uri;
    }
    include includes/app.nginx.conf;
    rewrite (.*) /app.{{ENV_TLD}}$1 break;
    proxy_pass https://s3.amazonaws.com;
  }
  
  include includes/prerender.nginx.conf;
  
  location = / {
    limit_req zone=requests burst=6 nodelay;
    if ($logged_in = 1) {
      # if is not evil inside location to do return and rewrite...last
      return 302 https://members.{{ENV_TLD}}/my-dashboard;
    }
    
    if ($http_x_forwarded_proto = 'http') {
      return 301 https://members.{{ENV_TLD}}/;
    }
    
    include includes/mf01.nginx.conf;
  }

  location / {
    limit_req zone=requests burst=6 nodelay;
    include includes/mf01.nginx.conf;
    #include includes/wpengine.nginx.conf;
  }

  location /admin/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://community.{{ENV_TLD}}$request_uri;
  }

  location /ajaxdata/* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /audio/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /bugs {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://apps.{{ENV_TLD}}$request_uri;
  }

  location /contest/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location ^~/css/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    rewrite \/(.+)\.git(.+)\.(css)$ /$1.$3 break;
    autoindex off;
  }

  location /docusign {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /download/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /download-spec-page {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /dr {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /flash/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /font/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }
  location /fonts/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /html/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /i/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /i/m/ {
    limit_req zone=requests burst=6 nodelay;
    alias /nfs_shares/member_photos/;
  }

  location /images/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /includes/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /jive/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /js/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /longcontest {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /movies/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location ^~ /PactsInternalServlet {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location ^~ /PactsMemberServlet {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /pdfs/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location ^~ /photo {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /preview/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location ^~ /query {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /registration/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://members.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }

  location /registration2/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://members.{{ENV_TLD}}/register/?next=$http_x_forwarded_proto%3A%2F%2F$http_host$request_uri;
  }

  location /report {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://community.{{ENV_TLD}}/tc?module=LegacyReport;
  }

  location /report_jsp/ {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /reviews/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location ^~/scripts/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    rewrite \/(.+)\.git(.+)\.(js)$ /$1.$3 break;
    autoindex off;
  }

  location /smg {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /sponsors-tco11 {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /stat {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://community.{{ENV_TLD}}$request_uri;
  }

  location /static/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /statistics/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /tc {
    limit_req zone=requests burst=6 nodelay;
    if ($achievements = 0) {
      return 301 http://community.{{ENV_TLD}}$request_uri;
    }

    if ($request_uri = "/tc") {
      set $redirectFlag tr;
    }

    if ($args = "") {
      set $redirectFlag "${redirectFlag}ue";
    }

    if ($redirectFlag = "true") {
      return 301 https://members.{{ENV_TLD}}/;
    }

    client_max_body_size      100M;
    ajp_pass app_tc;
  }

  location /tco {
    limit_req zone=requests burst=6 nodelay;
    return 301 https://members.{{ENV_TLD}}/community/member-programs/topcoder-open/;
  } 

  location /video-wrapper {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /wiki {
    limit_req zone=requests burst=6 nodelay;
    return 301 http://apps.{{ENV_TLD}}$request_uri;
  }

  location /copilot/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /xml/ {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /xmlrpc.php {
    limit_req zone=requests burst=6 nodelay;
    deny all;
  }

  location /robots.txt {
    limit_req zone=requests burst=6 nodelay;
    root /data/nginx/apache_docs/tcdocs;
    autoindex off;
  }

  location /\?s=* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /\?mode=* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  location /\?mkt_tok=* {
    limit_req zone=requests burst=6 nodelay;
    include includes/apache.www.nginx.conf;
  }

  # redirect server error pages to the static page /50x.html
  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    limit_req zone=requests burst=6 nodelay;
    root html;
  }

  location /www_topcoder_status {
    limit_req zone=requests burst=6 nodelay;
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    allow 54.172.147.189;
    deny all;
  }
}
